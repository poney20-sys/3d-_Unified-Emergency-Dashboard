<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—×"×œ ×”× ×“×¡×™ × ×¡ ×¦×™×•× ×” - ××¢×¨×›×ª ××•×˜×•××˜×™×ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        :root { --bg: #0f0f0f; --panel: #1a1a1a; --accent: #00bcf2; --danger: #ff4444; }
        body { margin: 0; background: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', system-ui; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 360px; background: var(--panel); border-left: 2px solid #333; display: flex; flex-direction: column; padding: 25px; box-shadow: 5px 0 15px rgba(0,0,0,0.5); z-index: 100; }
        #main-view { flex-grow: 1; position: relative; }
        .upload-area { border: 2px dashed #444; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.3s; background: #222; }
        .upload-area:hover { border-color: var(--accent); background: #2a2a2a; }
        #drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #0098c7; }
        #floor-navigation { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px; }
        .floor-btn { background: #333; color: white; border: 1px solid #444; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .floor-btn:hover { background: #444; }
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">×”-AI ×× ×ª×— ××ª ×”×§×•××•×ª...<br>×–×” ×œ×•×§×— ×›-15 ×©× ×™×•×ª</div>
</div>

<div id="sidebar">
    <h1 style="color:var(--accent); margin:0 0 5px 0; font-size:24px;">× ×¡ ×¦×™×•× ×” - ×©×•"×‘</h1>
    <p style="font-size:13px; color:#888; margin-bottom:20px;">× ×™×ª×•×— ×”× ×“×¡×™ ×•×ª×œ×ª-×××“ ×‘×–××Ÿ ×××ª</p>
    
    <div class="upload-area" onclick="document.getElementById('file-input').click()">
        <span style="font-size:24px;">ğŸ“</span><br>
        <span id="upload-status">×‘×—×¨ ×ª××•× ×•×ª ×©×œ ×”×’×¨××•×©×§×”</span>
        <input type="file" id="file-input" multiple hidden onchange="updateFileList(this.files)">
    </div>

    <div id="file-list" style="font-size: 11px; color: #888; margin-top: 10px; max-height: 60px; overflow-y: auto;"></div>

    <button id="process-btn" class="btn btn-primary" onclick="runAnalysis()">×”×¤×¢×œ × ×™×ª×•×— ×•×™×™×¦×•×¨ ××•×“×œ</button>

    <div id="floor-navigation"></div>

    <div id="building-data" style="margin-top:25px; background:#252525; padding:15px; border-radius:8px; display:none;">
        <h3 id="b-title" style="margin-top:0; color:var(--accent);"></h3>
        <div id="b-details" style="font-size:14px; line-height:1.5;"></div>
    </div>
</div>

<div id="main-view">
    <canvas id="drawing-layer"></canvas>
    <div style="position:absolute; bottom:25px; right:25px; z-index:20; display:flex; flex-direction:column; gap:10px; width:120px;">
        <button class="btn" style="background:var(--danger);" onclick="toggleDrawMode()">âœï¸ ×¦×™×™×¨</button>
        <button class="btn" style="background:#444;" onclick="clearCanvas()">ğŸ—‘ï¸ × ×§×”</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const API_KEY = "AIzaSyCggFk7n7qVRbcSHhwI1HAiadssVueeyCY";
    const genAI = new GoogleGenerativeAI(API_KEY);

    let scene, camera, renderer, floorGroup;
    let canvas, buildingData;

    // --- ××ª×—×•×œ 3D ---
    function init3D() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 360) / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth - 360, window.innerHeight);
        document.getElementById('main-view').appendChild(renderer.domElement);
        
        floorGroup = new THREE.Group();
        scene.add(floorGroup);
        scene.add(new THREE.AmbientLight(0xffffff, 1), new THREE.DirectionalLight(0xffffff, 0.5));
        
        camera.position.set(12, 12, 12);
        camera.lookAt(0, 4, 0);
        animate();
    }
    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

    // --- ××ª×—×•×œ ×¦×™×•×¨ ---
    canvas = new fabric.Canvas('drawing-layer', {
        width: window.innerWidth - 360,
        height: window.innerHeight,
        isDrawingMode: false
    });
    canvas.freeDrawingBrush.color = "red";
    canvas.freeDrawingBrush.width = 4;

    // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×’×œ×•×‘×œ×™×•×ª ---
    window.updateFileList = (files) => {
        document.getElementById('file-list').innerHTML = Array.from(files).map(f => `<div>âœ… ${f.name}</div>`).join('');
        document.getElementById('upload-status').innerText = `${files.length} ×§×‘×¦×™× × ×‘×—×¨×•`;
    };

    window.toggleDrawMode = () => {
        canvas.isDrawingMode = !canvas.isDrawingMode;
        alert(canvas.isDrawingMode ? "××¦×‘ ×¦×™×•×¨ ×¤×¢×™×œ - ×¡××Ÿ ×¢×œ ×”××¡×š" : "××¦×‘ ×ª×¦×•×’×” ×¤×¢×™×œ");
    };

    window.clearCanvas = () => canvas.clear();

    // --- ×”×œ×™×‘×”: × ×™×ª×•×— ×”-AI ---
    async function fileToGenerativePart(file) {
        const base64EncodedDataPromise = new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
        return { inlineData: { data: await base64EncodedDataPromise, mimeType: file.type } };
    }

    window.runAnalysis = async () => {
        const files = document.getElementById('file-input').files;
        if (files.length === 0) return alert("×× × ×‘×—×¨ ×œ×¤×—×•×ª ×ª××•× ×” ××—×ª ×©×œ ×’×¨××•×©×§×”");

        document.getElementById('loading-overlay').style.display = 'flex';
        
        try {
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const prompt = `××ª×” ×× ×ª×— ×”× ×“×¡×™ ×¢×‘×•×¨ ×›×•×—×•×ª ×—×™×¨×•×. × ×ª×— ××ª ×ª××•× ×•×ª ×”×’×¨××•×©×§×” ×”××¦×•×¨×¤×•×ª.
            ×–×”×” ××ª ×›×œ ×”×§×•××•×ª ×”×§×™×™××•×ª. ×¢×‘×•×¨ ×›×œ ×§×•××” ×—×œ×¥ ××™×§×•× ××"×“, ××¨×•× ×•×ª ×—×©××œ ×•×’×–.
            ×”×—×–×¨ ××š ×•×¨×§ ×§×•×“ JSON ×ª×§×™×Ÿ ×‘×¤×•×¨××˜ ×”×‘×:
            { "buildingName": "×©× ×”××‘× ×”", "floors": [ { "level": 0, "description": "×ª×™××•×¨ ×§×¦×¨", "mamad": "××™×§×•× ××“×•×™×§" } ] }`;

            const imageParts = await Promise.all([...files].map(fileToGenerativePart));
            const result = await model.generateContent([prompt, ...imageParts]);
            const response = await result.response;
            const text = response.text().replace(/```json|```/g, "");
            
            buildingData = JSON.parse(text);
            renderModel(buildingData);
        } catch (error) {
            console.error(error);
            alert("×©×’×™××” ×‘× ×™×ª×•×—: ×•×•×“× ×©×”×ª××•× ×•×ª ×‘×¨×•×¨×•×ª ×•×©×”××¤×ª×— ×ª×§×™×Ÿ");
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    };

    function renderModel(data) {
        floorGroup.clear();
        const nav = document.getElementById('floor-navigation');
        const dataPanel = document.getElementById('building-data');
        nav.innerHTML = '';
        dataPanel.style.display = 'block';
        document.getElementById('b-title').innerText = data.buildingName;

        data.floors.forEach((f, i) => {
            const geo = new THREE.BoxGeometry(10, 2.5, 8);
            const mat = new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.5, wireframe: true });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.y = i * 3;
            floorGroup.add(mesh);

            const btn = document.createElement('button');
            btn.className = 'floor-btn';
            btn.innerText = `×§×•××” ${f.level}`;
            btn.onclick = () => {
                floorGroup.children.forEach((m, idx) => { m.visible = (idx === i); m.material.wireframe = false; });
                document.getElementById('b-details').innerHTML = `<b>×ª×™××•×¨:</b> ${f.description}<br><b style="color:red;">××"×“:</b> ${f.mamad}`;
            };
            nav.appendChild(btn);
        });
    }

    init3D();
</script>
</body>
</html>
