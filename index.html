<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×©×œ×™×˜×” ×§×•××ª×™×ª - × ×¡ ×¦×™×•× ×”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body { margin: 0; background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 320px; background: #1e1e1e; padding: 20px; border-left: 1px solid #333; display: flex; flex-direction: column; gap: 15px; }
        #viewer-container { flex-grow: 1; position: relative; background: radial-gradient(circle, #222 0%, #000 100%); }
        canvas#drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; touch-action: none; }
        .floor-btn { padding: 10px; background: #333; border: 1px solid #444; color: white; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .floor-btn.active { background: #0078d4; border-color: #00bcf2; }
        .controls { position: absolute; top: 20px; right: 20px; z-index: 20; display: flex; gap: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; }
        button.tool-btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #status-tag { padding: 5px 10px; border-radius: 20px; font-size: 12px; display: inline-block; background: #2d2d2d; color: #00ff00; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="margin:0; color:#00bcf2;">× ×¡ ×¦×™×•× ×” - ××‘× ×” ×—×™×¨×•×</h2>
    <div id="status-tag">××¦×‘: ××•×“×œ ×¤×¢×™×œ</div>
    <div id="floor-navigation">
        <p><b>×‘×—×¨ ×ª×¦×•×’×”:</b></p>
        <button class="floor-btn active" onclick="showAll()">ğŸ¢ ×‘× ×™×™×Ÿ ××œ×</button>
        <div id="floor-list" style="display:flex; flex-direction:column; gap:5px; margin-top:10px;"></div>
    </div>
    <hr style="width:100%; border:0; border-top:1px solid #333;">
    <div id="data-panel">
        <p>×××ª×™×Ÿ ×œ× ×ª×•× ×™ ×§×•××”...</p>
    </div>
</div>

<div id="viewer-container">
    <canvas id="drawing-layer"></canvas>
    <div class="controls">
        <button class="tool-btn" style="background:#ff4444;" onclick="setDrawMode()">âœï¸ ×¦×™×™×¨</button>
        <button class="tool-btn" style="background:#555;" onclick="clearCanvas()">ğŸ—‘ï¸ × ×§×”</button>
        <button class="tool-btn" style="background:#44ff44; color:black;" onclick="captureScreen()">ğŸ’¾ ×©××•×¨ ×ª××•× ×”</button>
    </div>
</div>

<script>
    let buildingData = { floors: [] };
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 320) / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth - 320, window.innerHeight);
    document.getElementById('viewer-container').appendChild(renderer.domElement);

    const light = new THREE.AmbientLight(0x404040, 2); 
    const dLight = new THREE.DirectionalLight(0xffffff, 1);
    dLight.position.set(5, 10, 7.5);
    scene.add(light, dLight);

    const floorGroup = new THREE.Group();
    scene.add(floorGroup);

    // --- ×¢×™×‘×•×“ × ×ª×•× ×™× ××”-URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const rawData = urlParams.get('data');
    if (rawData) {
        try {
            buildingData = JSON.parse(atob(rawData)); // ×¤×¢× ×•×— Base64
            initSystem();
        } catch(e) { console.error("Data error", e); }
    }

    function initSystem() {
        const list = document.getElementById('floor-list');
        buildingData.floors.forEach((f, i) => {
            const btn = document.createElement('button');
            btn.className = 'floor-btn';
            btn.innerText = `×§×•××” ${f.level}`;
            btn.onclick = () => showFloor(i);
            list.appendChild(btn);
        });
        showAll();
    }

    function showFloor(index) {
        floorGroup.children.forEach((child, i) => {
            child.visible = (i === index);
            child.material.wireframe = false;
        });
        updateSidebar(index);
    }

    function showAll() {
        floorGroup.children.forEach(child => {
            child.visible = true;
            child.material.wireframe = true;
        });
        document.getElementById('data-panel').innerHTML = "<p>××¦×™×’ ××‘× ×” ××œ× (×©×§×•×£)</p>";
    }

    function updateSidebar(index) {
        const f = buildingData.floors[index];
        document.getElementById('data-panel').innerHTML = `
            <h3>×§×•××” ${f.level}</h3>
            <p><b>××™×“×¢:</b> ${f.info}</p>
            <p style="color:#ff4444;"><b>××™×§×•× ××"×“:</b> ${f.mamad}</p>
        `;
    }

    // ×™×¦×™×¨×ª ×”×§×•××•×ª (×¡×™××•×œ×¦×™×” ×œ×¤×™ × ×ª×•× ×™×)
    buildingData.floors.forEach((f, i) => {
        const geo = new THREE.BoxGeometry(10, 2.8, 8);
        const mat = new THREE.MeshPhongMaterial({ color: 0x0078d4, transparent: true, opacity: 0.7 });
        const floor = new THREE.Mesh(geo, mat);
        floor.position.y = i * 3;
        floorGroup.add(floor);
    });

    camera.position.set(12, 12, 12);
    camera.lookAt(0, 5, 0);

    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
    animate();

    // ×©×›×‘×ª ×”×¦×™×•×¨ (Fabric.js)
    const canvas = new fabric.Canvas('drawing-layer', {
        width: window.innerWidth - 320,
        height: window.innerHeight,
        isDrawingMode: false
    });
    function setDrawMode() { canvas.isDrawingMode = !canvas.isDrawingMode; }
    function clearCanvas() { canvas.clear(); }
</script>
</body>
</html>
