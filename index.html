<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×©×•"×‘ × ×¡ ×¦×™×•× ×” V12.0 - ×’×¨×¡×” ×—×¡×™× ×”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <style>
        :root { --accent: #00bcf2; --danger: #ff4444; --success: #28a745; --panel: #1a1a1a; }
        body { margin: 0; background: #000; color: white; font-family: system-ui; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 360px; background: var(--panel); padding: 25px; border-left: 2px solid #333; display: flex; flex-direction: column; box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
        #main-view { flex-grow: 1; position: relative; }
        .upload-area { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; background: #222; margin-bottom: 10px; }
        .upload-area:hover { border-color: var(--accent); }
        .file-tag { background: #333; color: var(--success); padding: 5px 10px; border-radius: 4px; margin: 5px 0; font-size: 12px; display: flex; justify-content: space-between; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; color: white; font-weight: bold; }
        #loading { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; }
    </style>
</head>
<body>
    <div id="loading">
        <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <p>×× ×ª×— ×ª×›× ×™×•×ª (PDF/IMAGE)...</p>
    </div>
    
    <div id="sidebar">
        <h1 style="color:var(--accent); margin:0;">×©×•"×‘ × ×¡ ×¦×™×•× ×”</h1>
        <p style="font-size:12px; color:#666;">×’×¨×¡×” 12.0 - ×ª××™×›×” ×‘-PDF ×•×”×“×‘×§×”</p>
        
        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <b>×”×“×‘×§ ×ª××•× ×” (Ctrl+V)</b><br>××• ×œ×—×¥ ×œ×”×¢×œ××ª PDF/×ª××•× ×”
            <input type="file" id="file-input" multiple hidden>
        </div>
        
        <div id="file-list" style="margin-bottom:15px;"></div>

        <button class="btn" style="background:var(--accent);" onclick="runAnalysis()">×”×¤×¢×œ × ×™×ª×•×— ××•×˜×•××˜×™</button>
        <div id="floor-nav" style="margin-top:20px; display:flex; gap:5px; flex-wrap:wrap;"></div>
        <div id="debug" style="margin-top:auto; font-family:monospace; font-size:11px; color:#555;">××¢×¨×›×ª ××•×›× ×”.</div>
    </div>

    <div id="main-view">
        <canvas id="drawing-layer"></canvas>
        <div style="position:absolute; bottom:25px; right:25px; z-index:20; display:flex; flex-direction:column; gap:10px; width:130px;">
            <button class="btn" style="background:var(--danger);" onclick="toggleDraw()">âœï¸ ×¦×™×™×¨</button>
            <button class="btn" style="background:#444;" onclick="fabricCanvas.clear()">ğŸ—‘ï¸ × ×§×”</button>
            <button class="btn" style="background:var(--success);" onclick="saveResult()">ğŸ“· ×©××•×¨</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const API_KEY = "AIzaSyDZ5zkaD7aEJeLPyDRc3CtzMFbcEPNuiuQ"; 
        const genAI = new GoogleGenerativeAI(API_KEY);
        let scene, camera, renderer, floorGroup, fabricCanvas, allFiles = [];

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 360) / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth - 360, window.innerHeight);
            document.getElementById('main-view').appendChild(renderer.domElement);
            floorGroup = new THREE.Group(); scene.add(floorGroup, new THREE.AmbientLight(0xffffff, 1.5));
            camera.position.set(12, 12, 12); camera.lookAt(0, 3, 0);
            fabricCanvas = new fabric.Canvas('drawing-layer', { width: window.innerWidth-360, height: window.innerHeight, isDrawingMode: false });
            fabricCanvas.freeDrawingBrush.color = "red"; fabricCanvas.freeDrawingBrush.width = 5;
            animate();
        }
        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

        function updateUI() {
            const list = document.getElementById('file-list');
            list.innerHTML = allFiles.map((f, i) => `<div class="file-tag"><span>ğŸ“„ ${f.name || 'Pasted File'}</span><span onclick="window.removeFile(${i})" style="cursor:pointer;color:red">âœ–</span></div>`).join('');
            document.getElementById('debug').innerText = `× ×˜×¢× ×• ${allFiles.length} ×§×‘×¦×™×.`;
        }
        window.removeFile = (idx) => { allFiles.splice(idx, 1); updateUI(); };

        window.addEventListener('paste', e => {
            for (let item of e.clipboardData.items) {
                if (item.type.includes("image") || item.type.includes("pdf")) {
                    allFiles.push(item.getAsFile());
                    updateUI();
                }
            }
        });

        document.getElementById('file-input').onchange = (e) => {
            allFiles = [...allFiles, ...Array.from(e.target.files)];
            updateUI();
        };

        window.runAnalysis = async () => {
            if (allFiles.length === 0) return alert("×”××¢×¨×›×ª ×œ× ×–×™×”×ª×” ×§×‘×¦×™×. ×× × ×”×“×‘×§ ××• ×”×¢×œ×” ×ª××•× ×”/PDF.");
            document.getElementById('loading').style.display = 'flex';
            try {
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const prompt = "Analyze these floor plans (images or PDF). Identify all floors and return ONLY a JSON: {\"name\": \"Building\", \"floors\": [{\"lvl\": 0, \"desc\": \"info\", \"safety\": \"mamad\"}]}";
                
                const parts = await Promise.all(allFiles.map(async f => {
                    const base64 = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result.split(',')[1]); rd.readAsDataURL(f); });
                    return { inlineData: { data: base64, mimeType: f.type } };
                }));

                const result = await model.generateContent([prompt, ...parts]);
                const responseText = (await result.response).text();
                const data = JSON.parse(responseText.match(/\{[\s\S]*\}/)[0]);
                
                floorGroup.clear(); document.getElementById('floor-nav').innerHTML = '';
                data.floors.forEach((f, i) => {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(10, 2.5, 8), new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.5, wireframe: true }));
                    m.position.y = i * 3; floorGroup.add(m);
                    const b = document.createElement('button'); b.innerText = `×§×•××” ${f.lvl}`; b.style.padding="8px"; b.onclick = () => { floorGroup.children.forEach((mesh, idx) => { mesh.visible = (idx === i); mesh.material.wireframe = false; }); };
                    document.getElementById('floor-nav').appendChild(b);
                });
                document.getElementById('debug').innerText = "> × ×™×ª×•×— ×”×•×©×œ×.";
            } catch (e) { 
                document.getElementById('debug').innerText = "> ×©×’×™××”: " + e.message;
                console.error(e);
            }
            document.getElementById('loading').style.display = 'none';
        };

        window.toggleDraw = () => fabricCanvas.isDrawingMode = !fabricCanvas.isDrawingMode;
        window.saveResult = () => {
            const temp = document.createElement('canvas'); temp.width = renderer.domElement.width; temp.height = renderer.domElement.height;
            const ctx = temp.getContext('2d'); ctx.drawImage(renderer.domElement, 0, 0);
            const img = new Image(); img.src = fabricCanvas.toDataURL();
            img.onload = () => { ctx.drawImage(img, 0, 0); const a = document.createElement('a'); a.download = 'emergency_plan.png'; a.href = temp.toDataURL(); a.click(); };
        };
        init();
        window.addEventListener('resize', () => { camera.aspect = (window.innerWidth - 360) / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth - 360, window.innerHeight); });
        log("spin animation loop");
    </script>
    <style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
</body>
</html>
