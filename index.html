<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>砖" 住 爪 - 专住转 专</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: system-ui; display: flex; height: 100vh; }
        #sidebar { width: 300px; background: #111; padding: 20px; border-left: 1px solid #333; }
        #viewer { flex-grow: 1; position: relative; }
        .btn { padding: 12px; width: 100%; margin-top: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 10; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>" 住 爪</h2>
        <p>1. 拽 转 (Ctrl+V)<br>2. 抓 注 驻转专:</p>
        <button class="btn" style="background:#00bcf2; color:white;" onclick="analyze()">驻注 转</button>
        <div id="status" style="margin-top:20px; color:#888;">.</div>
    </div>
    <div id="viewer">
        <canvas id="canvas-layer"></canvas>
        <div style="position:absolute; bottom:20px; right:20px; z-index:20;">
            <button class="btn" style="background:red; color:white;" onclick="toggleDraw()">锔 爪专</button>
            <button class="btn" style="background:green; color:white;" onclick="save()"> 砖专</button>
        </div>
    </div>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const API_KEY = "AIzaSyDZ5zkaD7aEJeLPyDRc3CtzMFbcEPNuiuQ"; // 驻转 砖 砖
        const genAI = new GoogleGenerativeAI(API_KEY);
        let scene, camera, renderer, floorGroup, fabricCanvas, allFiles = [];

        // 转 注专转
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, (window.innerWidth-300)/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth-300, window.innerHeight);
        document.getElementById('viewer').appendChild(renderer.domElement);
        floorGroup = new THREE.Group(); scene.add(floorGroup, new THREE.AmbientLight(0xffffff, 1.5));
        camera.position.set(10, 10, 10); camera.lookAt(0, 0, 0);
        fabricCanvas = new fabric.Canvas('canvas-layer', { width: window.innerWidth-300, height: window.innerHeight, isDrawingMode: false });
        fabricCanvas.freeDrawingBrush.color = "red"; fabricCanvas.freeDrawingBrush.width = 5;

        // 拽
        window.addEventListener('paste', e => {
            for (let item of e.clipboardData.items) {
                if (item.type.includes("image")) {
                    allFiles.push(item.getAsFile());
                    document.getElementById('status').innerText = `转 住驻.`;
                }
            }
        });

        // 转
        window.analyze = async () => {
            if (allFiles.length === 0) return alert("拽 转拽 转!");
            document.getElementById('status').innerText = "转...";
            try {
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const parts = await Promise.all(allFiles.map(async f => ({ inlineData: { data: await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result.split(',')[1]); rd.readAsDataURL(f); }), mimeType: f.type } })));
                const result = await model.generateContent(["Analyze floor plan. Return JSON: {\"floors\":[{\"lvl\":0,\"desc\":\"info\"}]}", ...parts]);
                const data = JSON.parse((await result.response).text().match(/\{[\s\S]*\}/)[0]);
                
                floorGroup.clear();
                data.floors.forEach((f, i) => {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 6), new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.5, wireframe: true }));
                    m.position.y = i * 3; floorGroup.add(m);
                });
                document.getElementById('status').innerText = "爪!";
            } catch (e) { document.getElementById('status').innerText = "砖: " + e.message; }
        };

        window.toggleDraw = () => fabricCanvas.isDrawingMode = !fabricCanvas.isDrawingMode;
        window.save = () => { const temp = document.createElement('canvas'); temp.width = renderer.domElement.width; temp.height = renderer.domElement.height; const ctx = temp.getContext('2d'); ctx.drawImage(renderer.domElement, 0, 0); const img = new Image(); img.src = fabricCanvas.toDataURL(); img.onload = () => { ctx.drawImage(img, 0, 0); const a = document.createElement('a'); a.download = 'plan.png'; a.href = temp.toDataURL(); a.click(); }; };
        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        animate();
    </script>
</body>
</html>
