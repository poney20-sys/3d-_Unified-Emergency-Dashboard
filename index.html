<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×—×™×¨×•× × ×¡ ×¦×™×•× ×” - V7.0 ×—×¡×™× ×”</title>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js](https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js)"></script>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js](https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js)"></script>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "[https://esm.run/@google/generative-ai](https://esm.run/@google/generative-ai)" } }
    </script>
    <style>
        :root { --bg: #0a0a0a; --panel: #161616; --accent: #00bcf2; --danger: #ff4444; }
        body { margin: 0; background: var(--bg); color: #e0e0e0; font-family: system-ui; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 360px; background: var(--panel); border-left: 1px solid #333; display: flex; flex-direction: column; padding: 25px; z-index: 100; }
        #main-view { flex-grow: 1; position: relative; }
        .upload-area { border: 2px dashed #444; padding: 25px; text-align: center; border-radius: 12px; cursor: pointer; background: #1a1a1a; }
        #drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; color: white; }
        .btn-primary { background: var(--accent); }
        #debug-console { margin-top: auto; font-family: monospace; font-size: 11px; color: #888; background: #000; padding: 10px; border-radius: 5px; max-height: 120px; overflow-y: auto; border: 1px solid #333; }
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="status-text">×× ×ª×— × ×ª×•× ×™× ×”× ×“×¡×™×™×...</div>
</div>

<div id="sidebar">
    <h2 style="color:var(--accent); margin:0;">×©×•"×‘ × ×¡ ×¦×™×•× ×”</h2>
    <p style="font-size:12px; color:#555; margin-bottom:20px;">×’×¨×¡×” 7.0 - ×× ×•×¢ × ×™×ª×•×— ××©×•×¤×¨</p>
    
    <div class="upload-area" onclick="document.getElementById('file-input').click()">
        <span>ğŸ“ <b>×”×“×‘×§ (Ctrl+V)</b> ××• ×‘×—×¨ ×ª××•× ×”</span>
        <input type="file" id="file-input" multiple hidden>
    </div>

    <div id="file-list" style="font-size:11px; margin-top:10px;"></div>

    <button class="btn btn-primary" onclick="runAnalysis()">×”×¤×¢×œ × ×™×ª×•×—</button>

    <div id="floor-nav" style="margin-top:20px; display:flex; gap:5px; flex-wrap:wrap;"></div>
    <div id="building-data" style="margin-top:20px; display:none; background:#111; padding:15px; border-radius:8px; border-right:3px solid var(--accent);">
        <h4 id="b-title" style="margin:0;"></h4>
        <div id="b-details" style="font-size:13px; margin-top:8px;"></div>
    </div>

    <div id="debug-console">××¢×¨×›×ª ××•×›× ×”. ×”××ª×Ÿ 5 ×“×§×•×ª ×œ××—×¨ ×©××™×¨×ª ×”××¤×ª×— ×‘-Cloud.</div>
</div>

<div id="main-view">
    <canvas id="drawing-layer"></canvas>
    <div style="position:absolute; bottom:20px; right:20px; z-index:20; display:flex; flex-direction:column; gap:8px;">
        <button class="btn" style="background:#444;" onclick="toggleDraw()">âœï¸ ×¦×™×™×¨</button>
        <button class="btn" style="background:#222;" onclick="clearCanvas()">ğŸ—‘ï¸ × ×§×”</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const API_KEY = "AIzaSyDXsIvtWq8mXRW179aa-zI6Dj95Ap_rfR8"; // ×”××¤×ª×— ×©×¡×™×¤×§×ª
    const genAI = new GoogleGenerativeAI(API_KEY);

    let scene, camera, renderer, floorGroup, fabricCanvas, allFiles = [];

    // --- ××ª×—×•×œ ××¢×¨×›×ª ---
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 360) / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth - 360, window.innerHeight);
        document.getElementById('main-view').appendChild(renderer.domElement);
        
        floorGroup = new THREE.Group();
        scene.add(floorGroup, new THREE.AmbientLight(0xffffff, 1));
        camera.position.set(10, 10, 10);
        camera.lookAt(0, 3, 0);

        fabricCanvas = new fabric.Canvas('drawing-layer', {
            width: window.innerWidth - 360, height: window.innerHeight, isDrawingMode: false
        });
        fabricCanvas.freeDrawingBrush.color = "red";
        fabricCanvas.freeDrawingBrush.width = 5;
        animate();
    }
    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

    const log = (msg, color = "#888") => {
        const c = document.getElementById('debug-console');
        c.innerHTML = `<span style="color:${color}">> ${msg}</span>`;
    };

    // --- ×˜×™×¤×•×œ ×‘×§×‘×¦×™× ---
    window.addEventListener('paste', (e) => {
        for (let item of e.clipboardData.items) {
            if (item.type.includes("image")) {
                allFiles.push(item.getAsFile());
                log("×ª××•× ×” ×”×•×“×‘×§×”. ××•×›×Ÿ ×œ× ×™×ª×•×—.", "var(--accent)");
            }
        }
    });

    document.getElementById('file-input').onchange = (e) => {
        allFiles = [...allFiles, ...Array.from(e.target.files)];
        log(`${allFiles.length} ×§×‘×¦×™× × ×‘×—×¨×•.`);
    };

    // --- × ×™×ª×•×— ×—×¡×™×Ÿ ---
    window.runAnalysis = async () => {
        if (allFiles.length === 0) return alert("×× × ×”×•×¡×£ ×ª××•× ×”.");
        document.getElementById('loading-overlay').style.display = 'flex';
        log("××ª×§×©×¨ ×¢× ×’×•×’×œ...");

        try {
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const prompt = `× ×ª×— ×’×¨××•×©×§×”. ×”×—×–×¨ ××š ×•×¨×§ JSON × ×§×™. ××‘× ×”: {"name": "×©×", "floors": [{"lvl": 0, "desc": "××™×“×¢", "safety": "××"×“"}]}`;

            const fileToPart = async (f) => ({ inlineData: { data: await new Promise(r => {
                const rd = new FileReader(); rd.onload = () => r(rd.result.split(',')[1]); rd.readAsDataURL(f);
            }), mimeType: f.type } });

            const parts = await Promise.all(allFiles.map(fileToPart));
            const result = await model.generateContent([prompt, ...parts]);
            let rawText = (await result.response).text();

            // × ×™×§×•×™ JSON - ××—×¤×© ×¨×§ ××ª ××” ×©×‘×™×Ÿ ×”×¡×•×’×¨×™×™× ×”××¡×•×œ×¡×œ×™×
            const jsonStart = rawText.indexOf('{');
            const jsonEnd = rawText.lastIndexOf('}') + 1;
            const cleanJson = rawText.substring(jsonStart, jsonEnd);

            const data = JSON.parse(cleanJson);
            render(data);
            log("× ×™×ª×•×— ×”×•×©×œ× ×‘×”×¦×œ×—×”!", "var(--success)");
        } catch (e) {
            log(`×©×’×™××”: ${e.message}`, "var(--danger)");
            console.error(e);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    };

    function render(data) {
        floorGroup.clear();
        const nav = document.getElementById('floor-nav'); nav.innerHTML = '';
        document.getElementById('building-data').style.display = 'block';
        document.getElementById('b-title').innerText = data.name;

        data.floors.forEach((f, i) => {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 6), new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.5, wireframe: true }));
            mesh.position.y = i * 2.5;
            floorGroup.add(mesh);

            const btn = document.createElement('button');
            btn.innerText = `×§×•××” ${f.lvl}`;
            btn.className = 'btn'; btn.style.width = 'auto'; btn.style.background = '#333';
            btn.onclick = () => {
                floorGroup.children.forEach((m, idx) => { m.visible = (idx === i); m.material.wireframe = false; });
                document.getElementById('b-details').innerHTML = `<b>××™×“×¢:</b> ${f.desc}<br><b style="color:red;">××"×“:</b> ${f.safety}`;
            };
            nav.appendChild(btn);
        });
    }

    window.toggleDraw = () => fabricCanvas.isDrawingMode = !fabricCanvas.isDrawingMode;
    window.clearCanvas = () => fabricCanvas.clear();
    init();
</script>
</body>
</html>
