<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×©×•"×‘ × ×¡ ×¦×™×•× ×” V13.0 - FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <style>
        :root { --accent: #00bcf2; --danger: #ff4444; --success: #28a745; --bg: #0a0a0a; }
        body { margin: 0; background: var(--bg); color: white; font-family: system-ui; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 380px; background: #161616; padding: 25px; border-left: 2px solid #333; display: flex; flex-direction: column; z-index: 100; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        #main-view { flex-grow: 1; position: relative; background: #000; }

        /* ××–×•×¨ ×”×¢×œ××” ×¢× ×§×™ ×•×’×œ×•×™ */
        .upload-zone { border: 3px dashed var(--accent); padding: 30px; text-align: center; border-radius: 15px; cursor: pointer; background: #1e1e1e; transition: 0.3s; margin-bottom: 20px; }
        .upload-zone:hover { background: #252525; border-color: white; }
        
        /* ×¨×©×™××ª ×§×‘×¦×™× ×•×™×–×•××œ×™×ª */
        #file-gallery { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; overflow-y: auto; max-height: 150px; }
        .file-item { background: #252525; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; border-right: 4px solid var(--success); font-size: 13px; }
        
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; color: white; font-weight: bold; font-size: 16px; }
        .btn-primary { background: var(--accent); }
        
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="border: 5px solid #333; border-top: 5px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
    <p style="margin-top:20px; font-size:18px;">×¦×•×•×ª ×”××•××—×™× ×× ×ª×— ××ª ×”××‘× ×”...</p>
</div>

<div id="sidebar">
    <h1 style="color:var(--accent); margin:0 0 5px 0;">×©×•"×‘ × ×¡ ×¦×™×•× ×”</h1>
    <p style="font-size:12px; color:#777; margin-bottom:20px;">×’×¨×¡×” 13.0 - × ×™×”×•×œ ××™×¨×•×¢ ×”× ×“×¡×™</p>

    <div class="upload-zone" id="drop-area" onclick="document.getElementById('file-input').click()">
        <span style="font-size:40px;">ğŸ“‚</span><br>
        <b style="font-size:16px;">×œ×—×¥ ×›××Ÿ ×œ×”×¢×œ××ª ×§×•×‘×¥/PDF</b><br>
        <span style="font-size:13px; color:var(--accent);">××• ×¤×©×•×˜ ×”×“×‘×§ ×ª××•× ×” (Ctrl+V)</span>
        <input type="file" id="file-input" multiple hidden>
    </div>

    <div id="file-gallery"></div>

    <button class="btn btn-primary" id="analyze-btn" onclick="runFinalAnalysis()">×”×¤×¢×œ × ×™×ª×•×— ×•×”×¤×§×ª ××•×“×œ</button>

    <div id="floor-navigation" style="margin-top:20px; display:flex; gap:8px; flex-wrap:wrap;"></div>

    <div id="debug-log" style="margin-top:auto; font-family:monospace; font-size:11px; color:#444; background:#000; padding:10px; border-radius:5px;">×¡×˜×˜×•×¡: ×××ª×™×Ÿ ×œ×§×‘×¦×™×.</div>
</div>

<div id="main-view">
    <canvas id="drawing-layer"></canvas>
    <div style="position:absolute; bottom:30px; right:30px; z-index:20; display:flex; flex-direction:column; gap:12px; width:140px;">
        <button class="btn" style="background:var(--danger);" onclick="toggleDraw()">âœï¸ ×¦×™×™×¨/×‘×˜×œ</button>
        <button class="btn" style="background:#444;" onclick="fabricCanvas.clear()">ğŸ—‘ï¸ × ×§×” ××¡×š</button>
        <button class="btn" style="background:var(--success);" onclick="saveToWhatsapp()">ğŸ“· ×©××•×¨ ×•×©×ª×£</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const API_KEY = "AIzaSyDZ5zkaD7aEJeLPyDRc3CtzMFbcEPNuiuQ"; 
    const genAI = new GoogleGenerativeAI(API_KEY);

    let scene, camera, renderer, floorGroup, fabricCanvas;
    let loadedFiles = [];

    // --- ××ª×—×•×œ ××¢×¨×›×ª ---
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 380) / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth - 380, window.innerHeight);
        document.getElementById('main-view').appendChild(renderer.domElement);
        
        floorGroup = new THREE.Group();
        scene.add(floorGroup, new THREE.AmbientLight(0xffffff, 1.5));
        camera.position.set(12, 12, 12);
        camera.lookAt(0, 3, 0);

        fabricCanvas = new fabric.Canvas('drawing-layer', {
            width: window.innerWidth - 380, height: window.innerHeight, isDrawingMode: false
        });
        fabricCanvas.freeDrawingBrush.color = "red";
        fabricCanvas.freeDrawingBrush.width = 5;
        
        animate();
    }

    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

    // --- × ×™×”×•×œ ×§×‘×¦×™× ---
    const updateGallery = () => {
        const gallery = document.getElementById('file-gallery');
        gallery.innerHTML = loadedFiles.map((f, i) => `
            <div class="file-item">
                <span>ğŸ“„ ${f.name || '×ª××•× ×” ×©×”×•×“×‘×§×”'}</span>
                <b onclick="removeFile(${i})" style="color:var(--danger); cursor:pointer;">âœ–</b>
            </div>
        `).join('');
        document.getElementById('debug-log').innerText = `× ×˜×¢× ×• ${loadedFiles.length} ×§×‘×¦×™×.`;
    };

    window.removeFile = (i) => { loadedFiles.splice(i, 1); updateGallery(); };

    // ×”××–× ×” ×œ×”×“×‘×§×”
    window.addEventListener('paste', e => {
        for (let item of e.clipboardData.items) {
            if (item.type.includes("image") || item.type.includes("pdf")) {
                loadedFiles.push(item.getAsFile());
                updateGallery();
            }
        }
    });

    // ×”××–× ×” ×œ×‘×—×™×¨×ª ×§×•×‘×¥
    document.getElementById('file-input').onchange = (e) => {
        loadedFiles = [...loadedFiles, ...Array.from(e.target.files)];
        updateGallery();
    };

    // --- × ×™×ª×•×— AI ×¡×•×¤×™ ---
    window.runFinalAnalysis = async () => {
        if (loadedFiles.length === 0) return alert("×”××¢×¨×›×ª ×œ× ×–×™×”×ª×” ×§×‘×¦×™×. ×× × ×”×¢×œ×” ××• ×”×“×‘×§ ×ª××•× ×”/PDF.");
        document.getElementById('loading-overlay').style.display = 'flex';
        
        try {
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const prompt = "Analyze architectural plans. Return ONLY JSON: {\"floors\": [{\"lvl\": 0, \"desc\": \"info\", \"safety\": \"mamad\"}]}";

            const parts = await Promise.all(loadedFiles.map(async f => {
                const b64 = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result.split(',')[1]); rd.readAsDataURL(f); });
                return { inlineData: { data: b64, mimeType: f.type } };
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse((await result.response).text().match(/\{[\s\S]*\}/)[0]);

            floorGroup.clear();
            document.getElementById('floor-navigation').innerHTML = '';
            
            data.floors.forEach((f, i) => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(10, 2.5, 8), new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.5, wireframe: true }));
                m.position.y = i * 3;
                floorGroup.add(m);

                const b = document.createElement('button');
                b.style.cssText = "background:#333; color:white; border:1px solid #444; padding:8px; border-radius:5px; cursor:pointer;";
                b.innerText = `×§×•××” ${f.lvl}`;
                b.onclick = () => {
                    floorGroup.children.forEach((mesh, idx) => { mesh.visible = (idx === i); mesh.material.wireframe = false; });
                    document.getElementById('debug-log').innerText = `×§×•××” ${f.lvl}: ${f.safety}`;
                };
                document.getElementById('floor-navigation').appendChild(b);
            });
            document.getElementById('debug-log').innerText = "× ×™×ª×•×— ×”×•×©×œ× ×‘×”×¦×œ×—×”.";
        } catch (e) { 
            alert("×©×’×™××” ×‘× ×™×ª×•×—. ×•×•×“× ×©×œ×—×¦×ª ×¢×œ SAVE ×‘-Google Cloud.");
            document.getElementById('debug-log').innerText = "×©×’×™××”: " + e.message;
        } finally { document.getElementById('loading-overlay').style.display = 'none'; }
    };

    window.toggleDraw = () => fabricCanvas.isDrawingMode = !fabricCanvas.isDrawingMode;
    window.saveToWhatsapp = () => {
        const temp = document.createElement('canvas'); temp.width = renderer.domElement.width; temp.height = renderer
