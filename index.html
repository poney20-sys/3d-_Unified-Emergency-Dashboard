window.runAnalysis = async () => {
    if (allFiles.length === 0) return alert("אנא הוסף תמונה תחילה");
    const overlay = document.getElementById('loading-overlay');
    overlay.style.display = 'flex';
    const consoleBox = document.getElementById('debug-console');
    
    consoleBox.innerText = "> שולח בקשה ל-Gemini...";

    try {
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        const prompt = "Analyze floor plans and return JSON."; 

        const fileToPart = async (file) => {
            const base64 = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return { inlineData: { data: base64, mimeType: file.type } };
        };

        const parts = await Promise.all(allFiles.map(fileToPart));
        const result = await model.generateContent([prompt, ...parts]);
        
        // כאן המערכת בודקת את התשובה
        const response = await result.response;
        const text = response.text();
        consoleBox.innerText = "> תשובה התקבלה! מעבד נתונים...";
        
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        const data = JSON.parse(jsonMatch[0]);
        render(data);

    } catch (e) {
        // התיקון הקריטי: הצגת השגיאה האמיתית מגוגל
        console.error("API Error:", e);
        consoleBox.style.color = "#ff4444";
        consoleBox.innerText = `> שגיאת מערכת: ${e.message}`;
        
        if (e.message.includes("API key not valid")) {
            consoleBox.innerText += "\n[המפתח שהזנת לא תואם למפתח ב-Cloud]";
        } else if (e.message.includes("not enabled")) {
            consoleBox.innerText += "\n[חובה ללחוץ ENABLE ל-Generative Language API]";
        }
    } finally {
        overlay.style.display = 'none';
    }
};
