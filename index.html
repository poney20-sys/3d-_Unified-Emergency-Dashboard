<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×—×™×¨×•× × ×¡ ×¦×™×•× ×” - V8.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <style>
        :root { --bg: #0d0d0d; --panel: #1a1a1a; --accent: #00bcf2; --danger: #ff4444; }
        body { margin: 0; background: var(--bg); color: #e0e0e0; font-family: system-ui; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 380px; background: var(--panel); border-left: 2px solid #333; display: flex; flex-direction: column; position: relative; z-index: 100; }
        #main-view { flex-grow: 1; position: relative; background: #000; }
        
        /* ×©×•×¨×ª ×”×›×ª×™×‘×”/×”×¢×œ××” ×”×—×“×©×” */
        #input-container { padding: 20px; background: #222; border-top: 1px solid #333; }
        .input-wrapper { display: flex; align-items: center; background: #333; border-radius: 25px; padding: 5px 15px; border: 1px solid #444; }
        .input-wrapper:focus-within { border-color: var(--accent); }
        #fake-input { flex-grow: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; font-size: 14px; }
        .action-btn { background: #444; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .action-btn:hover { background: var(--accent); }

        #file-display-list { padding: 15px; flex-grow: 1; overflow-y: auto; font-size: 13px; }
        .file-item { display: flex; justify-content: space-between; background: #2a2a2a; padding: 8px; border-radius: 5px; margin-bottom: 5px; border-right: 3px solid var(--accent); }
        
        #drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; }
        .toolbar { position: absolute; top: 20px; left: 20px; z-index: 20; display: flex; gap: 10px; }
        .tool-btn { background: rgba(0,0,0,0.7); color: white; border: 1px solid #444; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        .tool-btn:hover { background: var(--accent); }
        
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="status-text">×× ×ª×— ×’×¨××•×©×§×”...</div>
</div>

<div id="sidebar">
    <div style="padding: 25px 25px 10px 25px;">
        <h1 style="color:var(--accent); margin:0; font-size:22px;">× ×¡ ×¦×™×•× ×” - ×©×•"×‘</h1>
        <p style="font-size:12px; color:#666;">×’×¨×¡×” 8.0 - ×ª×—× ×ª ×©×™×¨×•×ª ××—×ª</p>
    </div>

    <div id="file-display-list">
        <p id="empty-msg" style="color:#555; text-align:center; margin-top:50px;">×”×¢×œ×” ××• ×”×“×‘×§ ×ª××•× ×•×ª ×©×œ ×”×§×•××•×ª...</p>
    </div>

    <div id="floor-nav" style="padding: 0 20px 10px 20px; display: flex; gap: 5px; flex-wrap: wrap;"></div>

    <div id="input-container">
        <div class="input-wrapper">
            <button class="action-btn" onclick="document.getElementById('file-input').click()">+</button>
            <input type="text" id="fake-input" placeholder="×”×“×‘×§ ×›××Ÿ ××• ×œ×—×¥ ×¢×œ ×”×¤×œ×•×¡..." onpaste="handlePaste(event)">
            <input type="file" id="file-input" multiple hidden onchange="handleFileSelect(event)">
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background:var(--accent); border:none; padding:12px; border-radius:25px; color:white; font-weight:bold; cursor:pointer;" onclick="runAnalysis()">×”×¤×¢×œ × ×™×ª×•×— ×”× ×“×¡×™</button>
    </div>
</div>

<div id="main-view">
    <canvas id="drawing-layer"></canvas>
    <div class="toolbar">
        <button class="tool-btn" onclick="toggleDraw()">âœï¸ ×¦×™×™×¨</button>
        <button class="tool-btn" onclick="clearCanvas()">ğŸ—‘ï¸ × ×§×”</button>
        <button class="tool-btn" style="background:var(--danger);" onclick="saveResult()">ğŸ“· ×©××•×¨</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";
    const API_KEY = "AIzaSyDXsIvtWq8mXRW179aa-zI6Dj95Ap_rfR8";
    const genAI = new GoogleGenerativeAI(API_KEY);

    let scene, camera, renderer, floorGroup, fabricCanvas, allFiles = [];

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 380) / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth - 380, window.innerHeight);
        document.getElementById('main-view').appendChild(renderer.domElement);
        
        floorGroup = new THREE.Group();
        scene.add(floorGroup, new THREE.AmbientLight(0xffffff, 1));
        camera.position.set(10, 10, 10); camera.lookAt(0, 3, 0);

        fabricCanvas = new fabric.Canvas('drawing-layer', { width: window.innerWidth - 380, height: window.innerHeight, isDrawingMode: false });
        fabricCanvas.freeDrawingBrush.color = "red"; fabricCanvas.freeDrawingBrush.width = 5;
        animate();
    }
    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

    // --- × ×™×”×•×œ ×”×¢×œ××•×ª ---
    window.handleFileSelect = (e) => { addFiles(Array.from(e.target.files)); };
    window.handlePaste = (e) => {
        const items = e.clipboardData.items;
        for (let item of items) { if (item.type.includes("image")) addFiles([item.getAsFile()]); }
    };
    function addFiles(files) {
        allFiles = [...allFiles, ...files];
        document.getElementById('empty-msg').style.display = 'none';
        const list = document.getElementById('file-display-list');
        list.innerHTML = allFiles.map((f, i) => `<div class="file-item"><span>âœ… ${f.name || '×ª××•× ×” ×©×”×•×“×‘×§×”'}</span></div>`).join('');
    }

    window.runAnalysis = async () => {
        if (allFiles.length === 0) return alert("×× × ×”×•×¡×£ ×ª××•× ×”.");
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const prompt = `Return ONLY JSON: {"name": "Building", "floors": [{"lvl": 0, "desc": "info", "safety": "mamad"}]}`;
            const parts = await Promise.all(allFiles.map(async f => ({ inlineData: { data: await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result.split(',')[1]); rd.readAsDataURL(f); }), mimeType: f.type } })));
            const result = await model.generateContent([prompt, ...parts]);
            const text = (await result.response).text().match(/\{[\s\S]*\}/)[0];
            render(JSON.parse(text));
        } catch (e) { alert("×©×’×™××” ×‘× ×™×ª×•×—. ×•×•×“× ×©×”××¤×ª×— ×‘-Cloud × ×©××¨."); }
        finally { document.getElementById('loading-overlay').style.display = 'none'; }
    };

    function render(data) {
        floorGroup.clear(); const nav = document.getElementById('floor-nav'); nav.innerHTML = '';
        data.floors.forEach((f, i) => {
            const m = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 6), new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.5, wireframe: true }));
            m.position.y = i * 2.5; floorGroup.add(m);
            const b = document.createElement('button'); b.innerText = `×§×•××” ${f.lvl}`; b.className = 'tool-btn';
            b.onclick = () => { floorGroup.children.forEach((mesh, idx) => { mesh.visible = (idx === i); mesh.material.wireframe = false; }); alert(`×§×•××” ${f.lvl}: ${f.desc}\n××"×“: ${f.safety}`); };
            nav.appendChild(b);
        });
    }

    window.toggleDraw = () => fabricCanvas.isDrawingMode = !fabricCanvas.isDrawingMode;
    window.clearCanvas = () => fabricCanvas.clear();
    window.saveResult = () => { const t = document.createElement('canvas'); t.width = renderer.domElement.width; t.height = renderer.domElement.height; const ctx = t.getContext('2d'); ctx.drawImage(renderer.domElement, 0, 0); const img = new Image(); img.src = fabricCanvas.toDataURL(); img.onload = () => { ctx.drawImage(img, 0, 0); const a = document.createElement('a'); a.download = 'plan.png'; a.href = t.toDataURL(); a.click(); }; };
    init();
</script>
</body>
</html>
