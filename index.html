<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="version" content="13.1.0">
    <title>×©×•"×‘ × ×¡ ×¦×™×•× ×” - ××¢×¨×›×ª ×—×¡×™× ×” V13.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <style>
        :root { --accent: #00bcf2; --danger: #ff4444; --success: #28a745; --bg: #0d0d0d; }
        body { margin: 0; background: var(--bg); color: white; font-family: system-ui; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 380px; background: #1a1a1a; padding: 25px; border-left: 2px solid #333; display: flex; flex-direction: column; z-index: 100; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        #main-view { flex-grow: 1; position: relative; background: #000; }

        /* ××–×•×¨ ×”×¢×œ××” ×‘×•×œ×˜ - ×¤×ª×¨×•×Ÿ ×œ×‘×¢×™×™×ª ×”"×œ× ×¨×•××”" */
        .upload-zone { border: 3px dashed var(--accent); padding: 40px 20px; text-align: center; border-radius: 15px; cursor: pointer; background: #222; transition: 0.3s; margin-bottom: 20px; }
        .upload-zone:hover { border-color: white; background: #2a2a2a; }
        
        .file-item { background: #333; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-right: 4px solid var(--success); }
        
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; color: white; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-primary { background: var(--accent); }
        .btn-primary:hover { opacity: 0.8; }
        
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; }
        
        .status-tag { font-size: 11px; color: #666; margin-top: auto; padding: 10px; background: #000; border-radius: 5px; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="border: 5px solid #333; border-top: 5px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
    <p style="margin-top:20px; font-size:18px;"><b>×× ×ª×— ×’×¨××•×©×§×•×ª ×‘×ª×œ×ª-×××“...</b></p>
</div>

<div id="sidebar">
    <h1 style="color:var(--accent); margin:0 0 5px 0;">×©×•"×‘ × ×¡ ×¦×™×•× ×”</h1>
    <p style="font-size:13px; color:#888; margin-bottom:20px;">×’×¨×¡×” 13.1 - ××¢×¨×›×ª ×—×¡×™× ×” ×œ××™×œ×•××™× ×•×—×™×¨×•×</p>

    <div class="upload-zone" id="drop-area" onclick="document.getElementById('file-input').click()">
        <span style="font-size:45px;">ğŸ“‚</span><br>
        <b style="font-size:18px;">×œ×—×¥ ×›××Ÿ ×œ×”×¢×œ××ª ×ª×›× ×™×•×ª</b><br>
        <span style="font-size:14px; color:var(--accent);">××• ×”×“×‘×§ ×ª××•× ×” (Ctrl+V)</span>
        <input type="file" id="file-input" multiple hidden>
    </div>

    <div id="file-list-container" style="max-height: 200px; overflow-y: auto;">
        </div>

    <button class="btn btn-primary" onclick="executeAnalysis()">×”×¤×¢×œ × ×™×ª×•×— ×•×”×¤×§×ª ××•×“×œ</button>

    <div id="floor-navigation" style="margin-top:20px; display:flex; gap:8px; flex-wrap:wrap;"></div>

    <div class="status-tag" id="status-console">×¡×˜×˜×•×¡: ×××ª×™×Ÿ ×œ×§×‘×¦×™×.</div>
</div>

<div id="main-view">
    <canvas id="drawing-layer"></canvas>
    <div style="position:absolute; bottom:30px; right:30px; z-index:20; display:flex; flex-direction:column; gap:12px; width:140px;">
        <button class="btn" style="background:var(--danger);" onclick="toggleDraw()">âœï¸ ×¦×™×™×¨/×‘×˜×œ</button>
        <button class="btn" style="background:#444;" onclick="fabricCanvas.clear()">ğŸ—‘ï¸ × ×§×” ××¡×š</button>
        <button class="btn" style="background:var(--success);" onclick="savePlan()">ğŸ“· ×©××•×¨ ×•×©×ª×£</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const API_KEY = "AIzaSyDZ5zkaD7aEJeLPyDRc3CtzMFbcEPNuiuQ"; 
    const genAI = new GoogleGenerativeAI(API_KEY);

    let scene, camera, renderer, floorGroup, fabricCanvas;
    let filesInQueue = [];

    // --- ××ª×—×•×œ ×× ×•×¢ ---
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 380) / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth - 380, window.innerHeight);
        document.getElementById('main-view').appendChild(renderer.domElement);
        
        floorGroup = new THREE.Group();
        scene.add(floorGroup, new THREE.AmbientLight(0xffffff, 1.5));
        camera.position.set(12, 12, 12);
        camera.lookAt(0, 3, 0);

        fabricCanvas = new fabric.Canvas('drawing-layer', {
            width: window.innerWidth - 380, height: window.innerHeight, isDrawingMode: false
        });
        fabricCanvas.freeDrawingBrush.color = "red";
        fabricCanvas.freeDrawingBrush.width = 5;
        
        animate();
    }

    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

    // --- × ×™×”×•×œ ×§×‘×¦×™× ×•×™×–×•××œ×™ ---
    const refreshFileList = () => {
        const container = document.getElementById('file-list-container');
        container.innerHTML = filesInQueue.map((f, i) => `
            <div class="file-item">
                <span>ğŸ“„ ${f.name || '×ª××•× ×” ×©×”×•×“×‘×§×”'}</span>
                <b onclick="removeFileFromQueue(${i})" style="color:var(--danger); cursor:pointer;">âœ–</b>
            </div>
        `).join('');
        document.getElementById('status-console').innerText = `× ×˜×¢× ×• ${filesInQueue.length} ×§×‘×¦×™×.`;
    };

    window.removeFileFromQueue = (i) => { filesInQueue.splice(i, 1); refreshFileList(); };

    window.addEventListener('paste', e => {
        for (let item of e.clipboardData.items) {
            if (item.type.includes("image") || item.type.includes("pdf")) {
                filesInQueue.push(item.getAsFile());
                refreshFileList();
            }
        }
    });

    document.getElementById('file-input').onchange = (e) => {
        filesInQueue = [...filesInQueue, ...Array.from(e.target.files)];
        refreshFileList();
    };

    // --- × ×™×ª×•×— AI ---
    window.executeAnalysis = async () => {
        if (filesInQueue.length === 0) return alert("×”××¢×¨×›×ª ×œ× ×–×™×”×ª×” ×§×‘×¦×™×. ×× × ×”×¢×œ×” ××• ×”×“×‘×§ ×ª××•× ×”/PDF.");
        document.getElementById('loading-overlay').style.display = 'flex';
        
        try {
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const prompt = "Analyze floor plans. Return JSON: {\"floors\": [{\"lvl\": 0, \"safety\": \"mamad info\"}]}";

            const parts = await Promise.all(filesInQueue.map(async f => {
                const b64 = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result.split(',')[1]); rd.readAsDataURL(f); });
                return { inlineData: { data: b64, mimeType: f.type } };
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const response = await result.response;
            const data = JSON.parse(response.text().match(/\{[\s\S]*\}/)[0]);

            floorGroup.clear();
            document.getElementById('floor-navigation').innerHTML = '';
            
            data.floors.forEach((f, i) => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(10, 2.5, 8), new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.5, wireframe: true }));
                m.position.y = i * 3;
                floorGroup.add(m);

                const b = document.createElement('button');
                b.style.cssText = "background:#333; color:white; border:1px solid #444; padding:8px; border-radius:5px; cursor:pointer;";
                b.innerText = `×§×•××” ${f.lvl}`;
                b.onclick = () => {
                    floorGroup.children.forEach((mesh, idx) => { mesh.visible = (idx === i); mesh.material.wireframe = false; });
                    document.getElementById('status-console').innerText = `×§×•××” ${f.lvl}: ${f.safety}`;
                };
                document.getElementById('floor-navigation').appendChild(b);
            });
            document.getElementById('status-console').innerText = "×”× ×™×ª×•×— ×”×¡×ª×™×™× ×‘×”×¦×œ×—×”.";
        } catch (e) { 
            alert("×ª×§×œ×”! ×•×•×“× ×©×œ×—×¦×ª ×¢×œ SAVE ×‘-Google Cloud.");
            document.getElementById('status-console').innerText = "×©×’×™××”: " + e.message;
        } finally { document.getElementById('loading-overlay').style.display = 'none'; }
    };

    window.toggleDraw = () => fabricCanvas.isDrawingMode = !fabricCanvas.isDrawingMode;
    window.savePlan = () => {
        const temp = document.createElement('canvas'); temp.width = renderer.domElement.width; temp.height = renderer.domElement.height;
        const ctx = temp.getContext('2d'); ctx.drawImage(renderer.domElement, 0, 0);
        const img = new Image(); img.src = fabricCanvas.toDataURL();
        img.onload = () => {
            ctx.drawImage(img, 0, 0);
            const a = document.createElement('a'); a.download = 'emergency_map.png'; a.href = temp.toDataURL(); a.click();
        };
    };

    init();
    window.addEventListener('resize', () => { renderer.setSize(window.innerWidth - 380, window.innerHeight); });
</script>
<style> @keyframes spin { to { transform: rotate(360deg); } } </style>
</body>
</html>
