<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—×"×œ ×”× ×“×¡×™ × ×¡ ×¦×™×•× ×” - ×ª×—× ×ª ×©×™×¨×•×ª ×××•×—×“×ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #00bcf2; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; }
        #sidebar { width: 350px; background: var(--panel); border-left: 2px solid #333; display: flex; flex-direction: column; padding: 20px; z-index: 100; }
        #main-view { flex-grow: 1; position: relative; }
        .upload-area { border: 2px dashed var(--accent); padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 20px; }
        #drawing-layer { position: absolute; top: 0; left: 0; z-index: 10; }
        .btn { padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .floor-nav { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 15px; }
        .floor-btn { background: #333; color: white; border: 1px solid #444; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

<div id="loading-overlay">â³ ×× ×ª×— ×’×¨××•×©×§×•×ª ×•××™×™×¦×¨ ××•×“×œ...</div>

<div id="sidebar">
    <h2 style="color:var(--accent); margin-top:0;">×—×"×œ × ×¡ ×¦×™×•× ×”</h2>
    
    <div class="upload-area" onclick="document.getElementById('file-input').click()">
        ğŸ“ ×”×¢×œ×” ×¦×™×œ×•××™ ×’×¨××•×©×§×” (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××” ×§×•××•×ª)
        <input type="file" id="file-input" multiple hidden onchange="handleFiles(this.files)">
    </div>

    <div id="file-list" style="font-size: 12px; color: #aaa;"></div>

    <button class="btn btn-primary" onclick="processWithAI()">×‘×¦×¢ × ×™×ª×•×— ×•×™×™×¦×•×¨ ××•×“×œ</button>

    <div id="floor-navigation" class="floor-nav"></div>

    <hr style="width:100%; border:0; border-top:1px solid #333; margin: 20px 0;">
    
    <div id="building-data">
        <p>×××ª×™×Ÿ ×œ×”×¢×œ××ª ×ª×›× ×™×•×ª...</p>
    </div>
</div>

<div id="main-view">
    <canvas id="drawing-layer"></canvas>
    <div style="position:absolute; bottom:20px; right:20px; z-index:20; display:flex; gap:10px;">
        <button class="btn" style="background:red;" onclick="toggleDraw()">âœï¸ ×¦×™×™×¨/×‘×˜×œ</button>
        <button class="btn" style="background:gray;" onclick="clearCanvas()">ğŸ—‘ï¸ × ×§×”</button>
    </div>
</div>

<script>
    let scene, camera, renderer, floorGroup;
    let canvas; // Fabric.js
    let currentData = null;

    // --- ××ª×—×•×œ ×× ×•×¢ 3D ---
    function init3D() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 350) / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth - 350, window.innerHeight);
        document.getElementById('main-view').appendChild(renderer.domElement);
        
        floorGroup = new THREE.Group();
        scene.add(floorGroup);
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        
        camera.position.set(15, 15, 15);
        camera.lookAt(0, 5, 0);
        animate();
    }

    function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

    // --- ××ª×—×•×œ ×©×›×‘×ª ×¦×™×•×¨ ---
    canvas = new fabric.Canvas('drawing-layer', {
        width: window.innerWidth - 350,
        height: window.innerHeight,
        isDrawingMode: false
    });
    canvas.freeDrawingBrush.color = "red";
    canvas.freeDrawingBrush.width = 5;

    function toggleDraw() { canvas.isDrawingMode = !canvas.isDrawingMode; }
    function clearCanvas() { canvas.clear(); }

    // --- ×˜×™×¤×•×œ ×‘×§×‘×¦×™× ---
    function handleFiles(files) {
        const list = document.getElementById('file-list');
        list.innerHTML = Array.from(files).map(f => `<div>âœ… ${f.name}</div>`).join('');
    }

    // --- ×—×™×‘×•×¨ ×œ-AI (×”×¡×™××•×œ×¦×™×” ×©×œ ×ª×—× ×ª ×”×©×™×¨×•×ª) ---
    async function processWithAI() {
        document.getElementById('loading-overlay').style.display = 'flex';
        
        // ×›××Ÿ ×ª×‘×•× ×”×¤× ×™×™×” ×œ-API. ×œ×¦×•×¨×š ×”×“×’××”, ×”××¢×¨×›×ª ××™×™×¦×¨×ª ××ª ×”××•×“×œ ×”×××•×—×“:
        setTimeout(() => {
            const mockData = {
                building: "××‘× ×” ××’×•×¨×™× ×¨×—×•×‘ ×•×™×¦××Ÿ",
                floors: [
                    { level: 0, info: "×§×•××ª ×›× ×™×¡×”, ××¨×•×Ÿ ×—×©××œ ×¨××©×™", mamad: "×¦×“ ×¦×¤×•×Ÿ" },
                    { level: 1, info: "×§×•××” ×˜×™×¤×•×¡×™×ª, 4 ×“×™×¨×•×ª", mamad: "××¨×›×– ×§×•××”" },
                    { level: 2, info: "×§×•××” ×˜×™×¤×•×¡×™×ª, 4 ×“×™×¨×•×ª", mamad: "××¨×›×– ×§×•××”" }
                ]
            };
            renderBuilding(mockData);
            document.getElementById('loading-overlay').style.display = 'none';
        }, 2000);
    }

    function renderBuilding(data) {
        currentData = data;
        floorGroup.clear();
        const nav = document.getElementById('floor-navigation');
        const info = document.getElementById('building-data');
        nav.innerHTML = '';
        
        data.floors.forEach((f, i) => {
            // ×™×¦×™×¨×ª ××•×“×œ 3D
            const geo = new THREE.BoxGeometry(10, 2.5, 8);
            const mat = new THREE.MeshPhongMaterial({ color: 0x00bcf2, transparent: true, opacity: 0.6, wireframe: true });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.y = i * 3;
            floorGroup.add(mesh);

            // ×™×¦×™×¨×ª ×›×¤×ª×•×¨×™ × ×™×•×•×˜
            const btn = document.createElement('button');
            btn.className = 'floor-btn';
            btn.innerText = `×§×•××” ${f.level}`;
            btn.onclick = () => focusFloor(i);
            nav.appendChild(btn);
        });

        info.innerHTML = `<h3>${data.building}</h3><p>××¡×¤×¨ ×§×•××•×ª: ${data.floors.length}</p>`;
    }

    function focusFloor(index) {
        floorGroup.children.forEach((f, i) => {
            f.visible = (i === index);
            f.material.wireframe = false;
        });
        const f = currentData.floors[index];
        document.getElementById('building-data').innerHTML = `
            <h3>×§×•××” ${f.level}</h3>
            <p>${f.info}</p>
            <p style="color:red;"><b>××"×“: ${f.mamad}</b></p>
        `;
    }

    window.onload = init3D;
</script>
</body>
</html>
